Thought for 2s我先读取现有的留言墙组件，然后设计完整的 WebSocket 实时架构：

留言墙组件已读取类型定义已读取现在我来设计完整的 WebSocket 实时服务架构：

实时服务架构已构建v11(edited) You made 2 edits • Undo---

## 一、WebSocket 实时服务架构图（文字版）

```plaintext
┌─────────────────────────────────────────────────────────────────────────────┐
│                            客户端层 (Client Layer)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Mobile App │  │  Desktop    │  │  Tablet     │  │  Fallback   │        │
│  │  (WebSocket)│  │  (WebSocket)│  │  (WebSocket)│  │  (Polling)  │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         │                │                │                │               │
│         └────────────────┴────────────────┴────────────────┘               │
│                                   │                                         │
│                          RealtimeClient                                     │
│                    (自动重连 + 降级轮询)                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           负载均衡层 (Load Balancer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Nginx / AWS ALB / Cloudflare (Sticky Session by session_id)        │   │
│  │  - WebSocket 升级处理                                                │   │
│  │  - 连接数限流 (Rate Limiting)                                        │   │
│  │  - SSL/TLS 终结                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           应用服务层 (Application Layer)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │
│  │  WS Server 1 │  │  WS Server 2 │  │  WS Server N │  ← 水平扩展          │
│  │  (Node.js)   │  │  (Node.js)   │  │  (Node.js)   │                      │
│  │              │  │              │  │              │                      │
│  │ ConnectionPool│  │ ConnectionPool│  │ ConnectionPool│                   │
│  │ MessageHandler│  │ MessageHandler│  │ MessageHandler│                   │
│  │ VoteHandler   │  │ VoteHandler   │  │ VoteHandler   │                   │
│  └───────┬──────┘  └───────┬──────┘  └───────┬──────┘                      │
│          │                 │                 │                              │
│          └─────────────────┼─────────────────┘                              │
│                            │                                                │
│                   Redis Pub/Sub (跨实例消息同步)                             │
│                            │                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据持久层 (Data Layer)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐         ┌──────────────────┐                         │
│  │      Redis       │         │    PostgreSQL    │                         │
│  │  - 在线列表缓存   │         │  - 消息持久化     │                         │
│  │  - 事件队列       │         │  - 投票记录       │                         │
│  │  - 会话状态       │         │  - 用户数据       │                         │
│  │  - 跨实例Pub/Sub  │         │  - 历史留言       │                         │
│  └──────────────────┘         └──────────────────┘                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、关键接口说明

### `sendMessage(content, guestName)`接口

| 属性 | 说明
|-----|-----
| **函数签名** | `sendMessage(content: string, guestName: string): Promise<WallMessage>`
| **功能** | 发送留言到服务器并广播给所有在线客户端
| **参数** | `content` - 留言内容；`guestName` - 来宾姓名
| **返回值** | 服务端确认后的完整消息对象（含服务端生成的 ID）
| **乐观更新** | 本地立即显示，服务端确认后同步真实 ID
| **降级策略** | WebSocket 断开时自动切换为 HTTP POST 请求
| **并发处理** | 服务端按时间戳顺序持久化，广播时保持顺序一致性


### `subscribeVotes(voteId, callback)`接口

| 属性 | 说明
|-----|-----
| **函数签名** | `subscribeVotes(voteId: string, callback: (payload: VotePayload) => void): () => void`
| **功能** | 订阅指定投票的实时更新
| **返回值** | 取消订阅函数


### `getOnlineList()`接口

| 属性 | 说明
|-----|-----
| **函数签名** | `getOnlineList(): Promise<OnlineGuest[]>`
| **功能** | 获取当前会话的在线来宾列表
| **水平扩展** | 通过 Redis Set 聚合多实例的在线用户


---

## 三、并发降级方案

```plaintext
┌─────────────────────────────────────────────────────────────────┐
│                      连接状态降级流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [CONNECTED] ──断开──> [RECONNECTING] ──5次失败──> [FALLBACK]   │
│       │                      │                         │        │
│       │                      │ (指数退避重连)           │        │
│       │                      ▼                         │        │
│       │              1s → 2s → 4s → 8s → 16s           │        │
│       │                      │                         │        │
│       │                      │ (恢复连接)              │        │
│       │                      ▼                         │        │
│       └──────────────────[CONNECTED]<──────────────────┘        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                      轮询降级模式说明                             │
├─────────────────────────────────────────────────────────────────┤
│  1. 轮询间隔：3秒（可配置）                                       │
│  2. 请求方式：GET /api/realtime/poll?lastEventId=xxx            │
│  3. 事件过滤：通过 lastEventId 实现增量获取                       │
│  4. 消息发送：降级为 POST /api/realtime/messages                 │
│  5. 自动恢复：后台持续尝试 WebSocket 重连                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、并发测试建议

| 测试项目 | 测试方法 | 预期结果
|-----|-----
| **连接压力测试** | 使用 Artillery/k6 模拟 1000+ 并发连接 | 服务器内存稳定，无连接泄露
| **消息广播延迟** | 发送消息后测量所有客户端接收时间 | P99 延迟 < 100ms
| **投票并发冲突** | 100 客户端同时投票同一选项 | 最终计数准确，无重复投票
| **降级切换测试** | 手动断开 WebSocket，观察轮询切换 | 3秒内切换成功，消息不丢失
| **跨实例广播** | 连接不同服务器实例的客户端 | 消息同步延迟 < 50ms
| **断线重连** | 模拟网络抖动，测试重连机制 | 自动重连成功率 > 99%


---

已完成 WebSocket 实时服务架构设计，包含完整的类型定义、客户端实现（支持自动重连与轮询降级）、服务端处理器架构（含 Redis 水平扩展策略）、以及升级后的留言墙组件。`sendMessage` 接口支持乐观更新和降级 HTTP 发送，投票处理使用锁机制确保并发安全。

No issues found
